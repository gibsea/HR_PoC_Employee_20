/*
	HR_EMP_ETL_EMP_Job.sql
	
	created:	20240308	Andy Rupp
	updated:
	
	This is a TEST release.
	populate the table HR_EMP_JOB.
	
*/

TRUNCATE	TABLE	CITD_D1_DEV.S2_HR.HR_EMP_JOB
;

insert	into	CITD_D1_DEV.S2_HR.HR_EMP_JOB
		(
		EMPLOYEE_ID
,		HOST_MANAGER 
,		CMPY_CD
,		BU_CD
,		DEPT_CD
,		OFFICE_CODE
,		EMP_CLASS_CD 
,		EMP_STATUS 
,		EVENT_CD 
,		EVENT_REASON_CD 
,		POSITION_CODE
,		REGULAR_TEMP 
,		IS_FULLTIME_EMPLOYEE 
,		FTE 
,		JOB_CODE 
,		JOB_GRADE
,		JOB_CODE_TITLE 
,		JOB_LEVEL 
,		DT_CRE_AT 
,		DT_CRE_BY 
,		DT_UPD_AT 
,		DT_UPD_BY 
,		DT_VALID_FROM 
,		DT_VALID_TO 
,		ACTIVE
		)
SELECT	DISTINCT
		EMPLOYEE_ID
,		MANAGER_ID
,		COMPANY_CD
,		BUSINESS_UNIT_CD
,		DEPARTMENT_CD
,		LOCATION_CD
,		EMPLOYEE_CLASS_CD
,		EMPLOYEE_STATUS_CD
,		EVENT_CD
,		EVENT_REASON_CD
,		POSITION
,		'NA' -- REGULARTEMP
,		IS_FTE_FLG
,		FTE
,		JOB_CODE
,		PAY_GRADE
,		TITLE
,		JOB_LEVEL
,		CREATED_DT
,		NULL
,		LAST_MODIFIED_DT
,		NULL
,		START_DT
,		CASE END_DT
		WHEN '9999-12-31 00:00:00.000'	then	NULL
								ELSE			JOB.END_DT
		END CASE			-- DT_VALID_TO
,		'1'
-- ,		min(START_DT)
-- ,		max(END_DT)
-- FROM	CORPITDATAPROD.EDW_LND_TB.SAPSF_EMP_JOB			JOB
FROM	CORPITDATAPROD.EDW_INT_TB.EMPLOYEE_JOB			JOB
LEFT JOIN
		CITD_D1_DEV.S2_REF.REF_ORG_DPT					DPT
	ON	(JOB.DEPARTMENT_CD			= DPT.DPT_ID)
where   (
        JOB.COMPANY_CD not like 'Kinaxis%'
    and JOB.COMPANY_CD not like 'Prana%'
    and JOB.COMPANY_CD not like 'Rubikloud%'
        )
--and	END_DT			IS null
GROUP	BY
		EMPLOYEE_ID
,		MANAGER_ID
,		COMPANY_CD
,		BUSINESS_UNIT_CD
,		DEPARTMENT_CD
,		LOCATION_CD
,		EMPLOYEE_CLASS_CD
,		EMPLOYEE_STATUS_CD
,		EVENT_CD
,		EVENT_REASON_CD
,		POSITION
,		'NA' -- REGULARTEMP
,		IS_FTE_FLG
,		FTE
,		JOB_CODE
,		PAY_GRADE
,		TITLE
,		JOB_LEVEL
,		CREATED_DT
,		LAST_MODIFIED_DT
,		START_DT
,		END_DT
order   by
        1,3,4,5
;
UPDATE	CITD_D1_DEV.S2_HR.HR_EMP_JOB
SET		ACTIVE			= '0'
where	DT_VALID_TO		IS NOT NULL
;
UPDATE	CITD_D1_DEV.S2_HR.HR_EMP_JOB
SET		ACTIVE			= '1'
where	DT_VALID_TO		IS NULL
;